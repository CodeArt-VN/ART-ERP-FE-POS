<ion-header>
	<ion-toolbar class="toolbar-no">
		<ion-buttons slot="start" *ngIf="pageConfig.isShowFeature" [ngClass]="{'ion-hide-sm-up': pageConfig.isShowFeature}">
			<ion-button (click)="pageConfig.isShowFeature = !pageConfig.isShowFeature;">
				<ion-icon slot="start" name="chevron-back-outline"></ion-icon>
				Trở lại
			</ion-button>
		</ion-buttons>

		<ion-title *ngIf="pageConfig.isShowFeature" [ngClass]="{'ion-hide-sm-up': pageConfig.isShowFeature}">Giỏ hàng</ion-title>
		<ion-buttons slot="end" class="full-width">
			<ion-searchbar [ngClass]="{'ion-hide-sm-down': pageConfig.isShowFeature}" slot="start" class="search-box" (ionFocus)="segmentChanged('all')" (ionChange)="search($event)" placeholder="{{'erp.app.pages.pos.pos-order.menu-placeholder' | translate}}"></ion-searchbar>
			<ion-button (click)="refresh()">
				<ion-icon color="primary" slot="icon-only" name="reload-outline"></ion-icon>
			</ion-button>
			<ion-button *ngIf="!pageConfig.isShowFeature" class="cart" title="{{'erp.app.pages.pos.pos-order.cart-placeholder' | translate}}" [ngClass]="{'blink': (printData.undeliveredItems?.length > 0) && pageConfig.canEdit}" (click)="pageConfig.isShowFeature = !pageConfig.isShowFeature;">
				<ion-icon color="primary" slot="icon-only" name="cart-outline"></ion-icon>
				<span *ngIf="item?._TotalQuantity">{{item._TotalQuantity}}</span>
			</ion-button>
			<ion-button [ngClass]="{'ion-hide-sm-down': pageConfig.isShowFeature}" *ngIf="pageConfig.isShowFeature" (click)="pageConfig.isShowFeature = !pageConfig.isShowFeature;">
				<ion-icon color="primary" slot="icon-only" name="close-circle-outline"></ion-icon>
			</ion-button>
		</ion-buttons>
	</ion-toolbar>
</ion-header>

<ion-content appScrollbarTheme appPrintFix class="table-list print-size-72" [ngClass]="{withFeature: pageConfig.isShowFeature}">
	<ion-fab slot="fixed" vertical="bottom" horizontal="end">
		<ion-fab-button (click)="callStaff()">
			<ion-icon name="megaphone-outline" ></ion-icon>
		</ion-fab-button>
	</ion-fab>
	<!-- list Item -->
	<ion-fab *ngIf="pageConfig.isShowFeature && item" class="feature no-print" vertical="top" horizontal="end" slot="fixed">
		<div id="pos-order-detail-page" style="position: absolute; z-index: 2;"></div>
		<form [formGroup]="formGroup" class="c-content" style="min-height: calc(100vh - 200px);">
			<!-- Dishes -->
			<div class="box" *ngIf="item?.Status=='Done' || item?.Status=='Cancelled'">
				<ion-row>
					<ion-col size="12" class="ion-text-center">
						<ion-button expand="full" fill="clear" (click)="helpOrder(item.Status)">
							<ion-text *ngIf="item?.Status=='Done'">Đơn hàng đã hoàn tất ?</ion-text>
							<ion-text *ngIf="item?.Status=='Cancelled'">Đơn hàng đã hủy ?</ion-text>
						</ion-button>
					</ion-col>
					<ion-col size="12" class="ion-text-center">
						<ion-button title="Quét mã QR">
							<ion-icon size="large" name="camera-outline"></ion-icon>
						</ion-button>
					</ion-col>
				</ion-row>
			</div>
			<div class="box" *ngIf="item?.Status=='Merged'">
				<ion-row style="padding: 10px;">
					<ion-col size="12" class="ion-text-center">
						<ion-button expand="full" fill="clear" (click)="helpOrder(item.Status)">
							<ion-text>Đơn hàng đã gộp ?</ion-text>
						</ion-button>
					</ion-col>
					<ion-col size="12">
						<ion-button (click)="goToOrder(parentOrder.IDSaleOrder,parentOrder.IDTable)" expand="block" fill="outline" color="primary">
							Bàn {{parentOrder.TableName}}
						</ion-button>
					</ion-col>
				</ion-row>			
			</div>
			<div class="box" *ngIf="item?.Status=='Splitted'">
				<ion-row style="padding: 10px;">
					<ion-col size="12" class="ion-text-center">
						<ion-button expand="full" fill="clear" (click)="helpOrder(item.Status)">
							<ion-text>Đơn hàng đã chia ?</ion-text>
						</ion-button>
					</ion-col>
					<ion-col size="6" *ngFor="let child of childrenOrders; let i = index">
						<ion-button (click)="goToOrder(child.IDSaleOrder,child.IDTable)" expand="block" fill="outline" color="primary" >
							Bàn {{child.TableName}}
						</ion-button>
					</ion-col>
				</ion-row>
				
			</div>
			<div class="box" *ngIf="item?.OrderLines?.length">
				<div style="padding: 0px 16px !important;">
					<div class="box-content" formArrayName="OrderLines">
						<ng-container *ngFor="let g of formGroup.get('OrderLines')['controls']; let idx = index;">
							<div class="od" [formGroup]="g" *ngIf="item.OrderLines[idx] as line">
								<div style="display: flex;">
									<div class="od-image clickable" [ngStyle]=" line._background " (click)="jumpToItem(line)"></div>
									<div class="od-info" *ngIf="line._item">
										<div class="od-name"><small class="od-id">#{{line._item.Id}}</small> {{line._item.Name}}</div>
										<div class="od-price">
											<span>{{line.UoMPrice | number: '1.0-0'}} <small *ngIf="line.TaxRate">+{{line.TaxRate}}% {{'erp.app.pages.pos.pos-order.vat' | translate}} </small> <small *ngIf="line.UoMName"> /{{line.UoMName}}</small></span>
										</div>
										<div>
											<ion-text *ngIf="line?.StatusText" [color]="line?.StatusColor"><small>{{line?.StatusText}}</small></ion-text>
										</div>
									</div>
								</div>

								<div class="od-quantity">
									<ion-button *ngIf="!line._Locked" title='Xóa bỏ sản phẩm này' fill="clear" color="danger" class="ion-float-right ion-no-padding remark-btn" size="small" (click)="addToCart(line._item,line.IDUoM, -(line.Quantity),true, idx); addToStorage(line._item, line.IDUoM, +1,true);">
										<ion-icon slot="icon-only" name="trash-outline"></ion-icon>
									</ion-button>
									<ion-button fill="outline" [disabled]="submitAttempt || line._Locked " class="ion-float-right qty-btn" size="small" (click)="addToCart(line._item, line.IDUoM, +1,true, idx);addToStorage(line._item, line.IDUoM, +1);">
										<ion-icon slot="icon-only" name="add"></ion-icon>
									</ion-button>
									<ion-button fill="outline" [disabled]="submitAttempt || line._Locked " class="ion-float-right qty-btn" size="small" (click)="addToCart(line._item,line.IDUoM, -1,true, idx);addToStorage(line._item, line.IDUoM, -1)">
										<ion-icon slot="icon-only" name="remove"></ion-icon>
									</ion-button>
									<ion-button title='Thêm ghi chú món ăn' fill="clear" color="warning" [disabled]="submitAttempt || line._Locked " class="ion-float-right" size="small" (click)="line._isShowNote = !line._isShowNote">
										<ion-icon slot="icon-only" [name]="((line.Remark?.length != 0) && (line.Remark != null))?'clipboard':'clipboard-outline'"></ion-icon>
									</ion-button>
									<span class="quantity">
										<small>x</small>
										<ion-text color="dark">
											{{line.Quantity}}
										</ion-text>
										<span class="uom" *ngIf="line.UoMName">({{line.UoMName}})</span>
										<!-- <span title="Đã chuyển bếp" *ngIf="line.ShippedQuantity>0">
											<ion-icon color="primary" name="arrow-redo"></ion-icon>
											<sup>{{line.ShippedQuantity}} </sup>
										</span> -->
									</span>
								</div>
								<div class="od-remark clickable" (click)="openQuickMemo(line)">
									<textarea class="clickable" cols="30" rows="10" formControlName="Remark" *ngIf="(line._isShowNote || line.Remark != null)" spellcheck="false" placeholder="Thêm ghi chú cho món"></textarea>
								</div>
							</div>
						</ng-container>
					</div>
				</div>
			</div>
			<div class="box ion-padding">
				<div class="box-content">
					<div class="check-out">
						<label class="c-label">Bàn
							<b class="c-value">
								{{Table.Name}}
							</b>
						</label>
						<label class="c-label">Tiền hàng
							<span class="c-value">
								{{item.OriginalTotalBeforeDiscount | number: '1.0-0'}}
							</span>
						</label>
						<label class="c-label" *ngIf="item.OriginalTotalDiscount>0">Chiết khấu
							<span class="c-value">
								{{item.OriginalTotalDiscount | number: '1.0-0'}}
							</span>
						</label>

						<label class="c-label" *ngIf="item.AdditionsAmount">Service charge
							<span class="c-value">{{item.AdditionsAmount | number: '1.0-0'}}</span>
						</label>

						<label class="c-label">VAT
							<span class="c-value">{{item.OriginalTax + item.AdditionsTax | number: '1.0-0'}}</span>
						</label>

						<label class="c-label" *ngIf="item.OriginalDiscountFromSalesman > 0">Chiết khấu NVBH
							<span class="c-value">{{item.OriginalDiscountFromSalesman | number: '1.0-0'}}</span>
						</label>

						<label class="c-label total">Tổng tiền
							<ion-text class="c-value total" [color]="item.OriginalTotalAfterTax >= 20000000? 'danger' : 'primary'">
								{{item.CalcTotalOriginal - item.OriginalDiscountFromSalesman | number: '1.0-0'}}
							</ion-text>
						</label>

						<label class="c-label" *ngIf="item.Received">Đã thanh toán
							<ion-text class="c-value" color="dark">
								{{item.Received | number: '1.0-0'}}
							</ion-text>
						</label>

						<label class="c-label" *ngIf="item.Received">Còn lại
							<ion-text class="c-value" color="dark">
								{{item.Debt | number: '1.0-0'}}
							</ion-text>
						</label>


					</div>
				</div>
			</div>

			<!-- <div class="box ion-padding">
				<div class="box-content">
					<div class="check-out">
						<ion-note>
							Trong trường hợp khẩn cấp, xin vui lòng gọi hotline
							<a [href]="'tel:'+Branch?.Phone">
								<ion-text color="danger">
									<b>{{ Branch?.Phone }}</b>
								</ion-text>
							</a>
						</ion-note>
					</div>
				</div>
			</div> -->

			<ion-button class="linear-blue-btn" *ngIf="pageConfig.canEdit" [disabled]="!AllowSendOrder" (click)="sendOrder()" expand="block" [fill]="AllowSendOrder? 'solid' : 'outline'">
				<ion-text *ngIf="id==0">Đặt hàng</ion-text>
				<ion-text *ngIf="id!=0">Cập nhật</ion-text>
			</ion-button>

			<ion-modal [isOpen]="isSuccessModalOpen">
				<ng-template>
					<ion-content [fullscreen]="true" class="ion-padding" [scrollY]="false">
						<ion-fab slot="fixed" vertical="top" horizontal="end">
							<ion-fab-button (click)="closeSuccessModal()">
								<ion-icon name="close"></ion-icon>
							</ion-fab-button>
						</ion-fab>
						<div class="ion-padding" class="customer-message">
							<div class="logo-wrapper">
								<img class="branch-logo" src="{{Branch?.LogoURL}}" title="{{Branch?.ShortName}}">
							</div>
							<div>
								<ion-text color="success">
									<h1>{{ this.id ? 'ĐÃ CẬP NHẬT ĐƠN HÀNG' : 'ĐÃ TIẾP NHẬN ĐƠN HÀNG' }}</h1>
								</ion-text>

								<p>
									Cảm ơn Quý khách đã đặt hàng. <br>
									Bộ phận phụ trách sẽ phục vụ Quý khách trong thời gian sớm nhất. <br>
									<br>
									<ion-note>
										Trong trường hợp khẩn cấp, xin vui lòng gọi hotline<br>
										<a [href]="'tel:'+Branch?.Phone">
											<ion-text color="danger">
												<b>{{ Branch?.Phone }}</b>
											</ion-text>
										</a>
									</ion-note>
								</p>
							</div>
							<div class="ion-padding"></div>
							<div class="ion-padding">
								<ion-button expand="block" (click)="closeSuccessModal()">Trở lại</ion-button>
							</div>
						</div>

					</ion-content>
				</ng-template>
			</ion-modal>


			<ion-button *ngIf="item.Status != 'Cancelled' && item?.Id != 0" class="ion-margin-top" expand="block" (click)="processPayments()">
				<ion-text *ngIf="item.Debt > 0 ">Thanh toán</ion-text>
				<ion-text *ngIf="item.Debt <= 0">Xem chi tiết</ion-text>
			</ion-button>
		</form>
		<div style="margin-top: 80px;"></div>
	</ion-fab>
	<ng-container *ngIf="OrdersOfTable?.length>0">
		<ion-fab slot="fixed" vertical="bottom" horizontal="start">
			<ion-fab-button id="open-modal-list-order">
				<ion-icon name="bag-handle-outline"></ion-icon> 
			</ion-fab-button>
		</ion-fab>
		<ion-modal trigger="open-modal-list-order" [initialBreakpoint]="0.5"
		[breakpoints]="[0, 0.5, 0.75]"
		handleBehavior="cycle">
			<ng-template>
				<div class="box">
					<div class="ion-padding">
						<div class="ion-margin-bottom ion-text-center"><ion-text><b>{{OrdersOfTable.length}} đơn hàng</b></ion-text></div>
						<ion-item lines="full" *ngFor="let order of OrdersOfTable" (click)="goToOrder(order.Id,idTable); closeModal()">
							<ion-text slot="start">Đơn hàng #{{order.Id}}</ion-text>
							<ion-text slot="end">{{order.Amount | number: '1.0-0'}} đ</ion-text>
						</ion-item>	
					</div>
				</div>
			</ng-template>
		</ion-modal>
	</ng-container>
	

	<ion-modal [isOpen]="isWifiSecuredModalOpen">
		<ng-template>
			<ion-content [fullscreen]="true" class="ion-padding" [scrollY]="false">
				<div class="ion-padding" class="customer-message">
					<div class="logo-wrapper">
						<img class="branch-logo" src="{{Branch?.LogoURL}}" title="{{Branch?.ShortName}}">
					</div>
					<div>
						<ion-text color="warning">
							<h1>KIỂM TRA KẾT NỐI MẠNG</h1>
						</ion-text>

						<p>
							Xin quý khách vui lòng sử dụng <br>
							wifi nhà hàng để đặt hàng<br>
							<br>
							<ion-note>
								Trong trường hợp khẩn cấp, xin vui lòng gọi hotline<br>
								<a [href]="'tel:'+Branch?.Phone">
									<ion-text color="danger">
										<b>{{ Branch?.Phone }}</b>
									</ion-text>
								</a>
							</ion-note>
						</p>
						
						<div class="ion-padding"></div>
						<div class="ion-padding">
							<ion-button expand="block" (click)="isWifiSecuredModalOpen = false">Đồng ý</ion-button>
						</div>
					</div>
				</div>

			</ion-content>
		</ng-template>
	</ion-modal>

	<!-- Menu Group -->
	<div class="no-print menu-holder">
		<div class="menu-group-list">
			<div class="menu-group" (click)="segmentChanged('all')">
				<ion-img #img [src]="AllSegmentImage" (ionError)="img.src = 'assets/pos-icons/POS-Item-demo.png'" [ngClass]="{selected: segmentView=='all'}"></ion-img>
				<ion-label>tất cả</ion-label>
			</div>
			<div class="menu-group" *ngFor="let g of menuList" (click)="segmentChanged(g.Id)">
				<ion-img [src]="g.Image ? ImagesServer + g.Image: 'assets/pos-icons/POS-Item-demo.png'" (ionError)="img.src = 'assets/pos-icons/POS-Item-demo.png'" [ngClass]="{selected: segmentView==g.Id}"></ion-img>
				<ion-label>{{g.Name}}</ion-label>
			</div>
		</div>
	</div>

	<!-- View MenuList -->
	<div class="no-print">
		<ion-grid fixed *ngIf="menuList?.length">
			<ng-container *ngFor="let g of menuList | filter:{Id:segmentView}">
				<ng-container *ngIf="g.Items?.length">

					<ion-row class="table-holder" *ngIf="(g.Items | searchNoAccent:{SearchName:query.Keyword}).length">

						<ion-col class="group-title" size="12" size-sm="12" size-md="12" size-xl="12">
							<ion-list-header class="ion-no-padding">
								<ion-label color="primary">{{g.Name}}</ion-label>
							</ion-list-header>
						</ion-col>

						<ion-col class="shadow table-item" [ngClass]="{'in-serve': i.BookedQuantity }" *ngFor="let i of g.Items | searchNoAccent:{SearchName:query.Keyword}">
							<!-- <span class="tag right" *ngIf="i.BookedQuantity">
								<ion-text class="tag-content" color="danger">
									{{i.BookedQuantity}}
								</ion-text>
							</span> -->
							<div class="card" [id]="'item'+i.Id">

								<ion-img class="item-image clickable" [title]="i.Name" #img [src]="i.imgPath" (ionError)="img.src = 'assets/pos-icons/POS-Item-demo.png'"></ion-img>
								<span class="table-name clickable">{{i.Name}}</span>
								<ng-container *ngFor="let u of i.UoMs">


									<a *ngIf="u.PriceList.length" class="price clickable">
										<span class="price-list" *ngFor="let p of u.PriceList">
											<span *ngIf="!p.NewPrice">
												{{p.Price | number: '1.0-0'}}
												<span class="uom"> /{{u.Name}}</span>
											</span>
											<span *ngIf="p.NewPrice">
												{{p.NewPrice | number: '1.0-0'}}
												<span class="uom"> /{{u.Name}}</span>
												<small class="old-price">{{p.Price | number: '1.0-0'}}</small> -{{(p.Price - p.NewPrice)/p.Price * 100  | number: '1.0-0'}}%

											</span>
										</span>

										<ion-button [ngClass]="{'linear-blue-btn': i.BookedQuantity}" [title]="i.BookedQuantity? i.BookedQuantity: '+'" class="ion-float-right add-to-cart-btn" size="small" (click)="addToCart(i, u.Id); addToStorage(i, u.Id, +1);">
											<ion-icon slot="icon-only" name="cart-outline"></ion-icon>
										</ion-button>
									</a>
								</ng-container>

							</div>
						</ion-col>

					</ion-row>
				</ng-container>
			</ng-container>
		</ion-grid>
		<app-page-message [itemsLength]="menuList.length" [showSpinner]="pageConfig.showSpinner"></app-page-message>
	</div>

	<div style="margin-top: 60px;"></div>
</ion-content>
