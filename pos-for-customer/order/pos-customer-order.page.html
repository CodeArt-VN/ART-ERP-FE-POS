<ion-header>
	<ion-toolbar class="toolbar-no">
		<ion-searchbar slot="start" class="search-box" (ionFocus)="segmentChanged('all')" (ionChange)="search($event)" placeholder="{{'erp.app.pages.pos.pos-order.menu-placeholder' | translate}}"></ion-searchbar>
		<ion-button color="none" slot="end" class="cart" title="{{'erp.app.pages.pos.pos-order.cart-placeholder' | translate}}" [ngClass]="{'blink': (printData.undeliveredItems?.length > 0) && pageConfig.canEdit}" (click)="pageConfig.isShowFeature = !pageConfig.isShowFeature;">
			<ion-icon color="primary" slot="icon-only" name="cart-outline"></ion-icon>
			<span *ngIf="item?._TotalQuantity">{{item._TotalQuantity}}</span>
		</ion-button>
	</ion-toolbar>
</ion-header>

<ion-content appScrollbarTheme appPrintFix class="table-list print-size-72" [ngClass]="{withFeature: pageConfig.isShowFeature}">
	
<ion-fab *ngIf="pageConfig.isShowFeature && item" class="feature no-print" vertical="top" horizontal="end" slot="fixed">
		<div id="pos-order-detail-page" style="position: absolute; z-index: 2;"></div>
		<form [formGroup]="formGroup" class="c-content" style="min-height: calc(100vh - 200px);">
			
			<div class="box" *ngIf="item?.OrderLines?.length">
				<div style="padding: 0px 16px !important;">
					<div class="box-content" formArrayName="OrderLines">
						<ng-container *ngFor="let g of formGroup.get('OrderLines')['controls']; let idx = index;">
							<div class="od" [formGroup]="g" *ngIf="item.OrderLines[idx] as line">
								<div style="display: flex;">								
									<div class="od-image clickable" [ngStyle]=" line._background " (click)="jumpToItem(line)"></div>
									<div class="od-info" *ngIf="line._item">
										<div class="od-name"><small class="od-id">#{{line._item.Id}}</small> {{line._item.Name}}</div>
										<div class="od-price">
											<span>{{line.UoMPrice | number: '1.0-0'}} <small *ngIf="line.TaxRate">+{{line.TaxRate}}% {{'erp.app.pages.pos.pos-order.vat' | translate}}</small></span>
										</div>
									</div>
								</div>

								<div class="od-quantity">
									<ion-button fill="outline" [disabled]="submitAttempt || line._Locked " class="ion-float-right qty-btn" size="small" (click)="addToCart(line._item, line.IDUoM, +1,true)">
										<ion-icon slot="icon-only" name="add"></ion-icon>
									</ion-button>
									<ion-button fill="outline" [disabled]="submitAttempt || line._Locked " class="ion-float-right qty-btn" size="small" (click)="addToCart(line._item,line.IDUoM, -1,true)">
										<ion-icon slot="icon-only" name="remove"></ion-icon>
									</ion-button>
									<ion-button title='Thêm ghi chú món ăn' fill="clear" color="warning" class="ion-float-right" size="small" (click)="line._isShowNote = !line._isShowNote">
										<ion-icon slot="icon-only" [name]="((line.Remark?.length != 0) && (line.Remark != null))?'clipboard':'clipboard-outline'"></ion-icon>
									</ion-button>
									<span class="quantity">
										<small>x</small>
										<ion-text color="dark">
											{{line.Quantity}}
										</ion-text>
										<span class="uom" *ngIf="line.UoMName">({{line.UoMName}})</span>
									</span>
								</div>
								<div class="od-remark clickable" >
									<textarea class="clickable" cols="30" rows="10" formControlName="Remark" *ngIf="line._isShowNote" spellcheck="false" placeholder="Thêm ghi chú cho món">
								</textarea>
								</div>
							</div>
						</ng-container>
					</div>
				</div>
			</div>		
			<div class="box ion-padding">
				
				<div class="box-content">
					
					<div class="check-out">
						<label class="c-label">Bàn
							<span class="c-value">
								{{Table.Name}}
							</span>
						</label>
						<label class="c-label">Tiền hàng
							<span class="c-value">
								{{item.OriginalTotalBeforeDiscount | number: '1.0-0'}}
							</span>
						</label>
						<!-- <label class="c-label clickable" *ngIf="pageConfig.canEdit" (click)="processDiscounts()">Chiết khấu <ion-icon name="open-outline"></ion-icon>
							<span class="c-value">
								{{item.OriginalTotalDiscount | number: '1.0-0'}}
							</span>

						</label> -->
						<label class="c-label" *ngIf="!pageConfig.canEdit">Chiết khấu
							<span class="c-value">
								{{item.OriginalTotalDiscount | number: '1.0-0'}}
							</span>
						</label>
						<label class="c-label">VAT
							<span class="c-value">{{item.OriginalTax | number: '1.0-0'}}</span>
						</label>

						<label class="c-label" *ngIf="item.CalcOriginalTotalAdditions">Service charge <i class="info-tooltip" title="Phí dịch vụ theo từng item có thể khác nhau."></i>
							<span class="c-value">{{item.CalcOriginalTotalAdditions | number: '1.0-0'}}</span>
						</label>

						<label class="c-label total">Tổng tiền
							<ion-text class="c-value total" [color]="item.OriginalTotalAfterTax >= 20000000? 'danger' : 'primary'">
								{{item.CalcTotalOriginal | number: '1.0-0'}}
							</ion-text>
						</label>						
					</div>
				</div>
				
			</div>	
			<ion-button *ngIf="pageConfig.canEdit" [disabled]="!AllowSendOrder" (click)="sendOrder()" expand="block" [fill]="AllowSendOrder? 'solid' : 'outline'">
				<ion-text >Đặt hàng</ion-text>
			</ion-button>
		</form>
	</ion-fab>

	<!-- Menu Group -->
	<div class="no-print menu-holder">
		<div class="menu-group-list">
			<div class="menu-group" (click)="segmentChanged('all')">
				<ion-img #img [src]="AllSegmentImage" (ionError)="img.src = 'assets/pos-icons/POS-Item-demo.png'" [ngClass]="{selected: segmentView=='all'}"></ion-img>
				<ion-label>tất cả</ion-label>
			</div>
			<div class="menu-group" *ngFor="let g of menuList" (click)="segmentChanged(g.Id)">
				<ion-img  [src]="g.Image ? ImagesServer + g.Image: 'assets/pos-icons/POS-Item-demo.png'" (ionError)="img.src = 'assets/pos-icons/POS-Item-demo.png'" [ngClass]="{selected: segmentView==g.Id}"></ion-img>
				<ion-label>{{g.Name}}</ion-label>
			</div>
		</div>
	</div>

	<!-- View MenuList -->
	<div class="no-print">
		<ion-grid fixed *ngIf="menuList?.length">
			<ng-container *ngFor="let g of menuList | filter:{Id:segmentView}">
				<ng-container *ngIf="g.Items?.length">

					<ion-row class="table-holder" *ngIf="(g.Items | search:{Name:query.Keyword}).length">

						<ion-col class="group-title" size="12" size-sm="12" size-md="12" size-xl="12">
							<ion-list-header class="ion-no-padding">
								<ion-label color="primary">{{g.Name}}</ion-label>
							</ion-list-header>
						</ion-col>

						<ion-col class="shadow table-item" [ngClass]="{'in-serve': i.BookedQuantity }" *ngFor="let i of g.Items | search:{Name:query.Keyword}">
							<span class="tag right" *ngIf="i.BookedQuantity">
								<ion-text class="tag-content" color="danger">
									{{i.BookedQuantity}}
								</ion-text>
							</span>
							<div class="card" [id]="'item'+i.Id">

								<ion-img class="item-image clickable" (click)="addToCart(i, i.UoMs[0].Id)" [title]="i.Name" [src]="i.Image ? ImagesServer + i.Image: 'assets/pos-icons/POS-Item-demo.png'"></ion-img>
								<span class="table-name clickable" (click)="addToCart(i, i.UoMs[0].Id)">{{i.Name}}</span>
								<ng-container *ngFor="let u of i.UoMs">
									

									<a *ngIf="u.PriceList.length" class="price clickable" (click)="addToCart(i, u.Id)">
										<span class="price-list" *ngFor="let p of u.PriceList">
											{{p.Price | number: '1.0-0'}}
										</span>
										<span class="uom">{{u.Name}}</span>
									</a>
								</ng-container>

							</div>
						</ion-col>

					</ion-row>
				</ng-container>
			</ng-container>
		</ion-grid>
		<app-page-message [itemsLength]="menuList.length" [showSpinner]="pageConfig.showSpinner"></app-page-message>
	</div>
	
</ion-content>
